<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modifier Questionnaire</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link href="/css/theme-septeo.css" rel="stylesheet" />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <header class="d-flex align-items-center justify-content-between mb-4">
        <div class="d-flex align-items-center">
          <img
            src="/img/logo-septeo.svg"
            alt="SEPTEO"
            height="40"
            class="me-3"
          />
          <h1 class="h3 mb-0 fw-semibold">Modifier un questionnaire</h1>
        </div>
        <div>
          <a href="/consult.html" class="btn btn-outline-secondary me-2"
            >Retour liste</a
          >
          <a href="/index.html" class="btn btn-primary"
            >Nouveau questionnaire</a
          >
        </div>
      </header>

      <!-- Formulaire chargé dynamiquement depuis index.html pour garantir l'exhaustivité -->
      <div id="formContainer" class="mb-4">Chargement du questionnaire…</div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const originalCabinetName = urlParams.get("cabinetName");
      if (!originalCabinetName) {
        alert("Paramètre cabinetName manquant dans l'URL.");
        window.location.href = "/consult.html";
      }

      let form; // sera défini après chargement du template
      let alertPlaceholder;

      async function injectFormTemplate() {
        try {
          const res = await fetch("/index.html");
          const htmlText = await res.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlText, "text/html");
          const templateForm = doc.getElementById("questionnaireForm");
          if (!templateForm) throw new Error("Formulaire de base introuvable.");
          document.getElementById("formContainer").innerHTML =
            templateForm.outerHTML;
          form = document.getElementById("questionnaireForm");

          // Placeholder pour alertes
          alertPlaceholder = document.getElementById("alertPlaceholder");

          // Mettre à jour le texte du bouton principal
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn)
            submitBtn.textContent = "Enregistrer les modifications";

          // Ajouter barre d'actions flottante (toujours visible)
          if (!document.getElementById("actionsBar")) {
            const bar = document.createElement("div");
            bar.id = "actionsBar";
            bar.className =
              "position-fixed bottom-0 start-0 end-0 bg-white border-top shadow p-3 d-flex justify-content-end gap-2";
            bar.style.zIndex = "1100";

            const cancelBtn = document.createElement("button");
            cancelBtn.type = "button";
            cancelBtn.className = "btn btn-outline-secondary";
            cancelBtn.textContent = "Annuler";
            cancelBtn.addEventListener("click", () => {
              loadData();
              window.scrollTo({ top: 0, behavior: "smooth" });
            });

            const saveBtn = document.createElement("button");
            saveBtn.type = "button";
            saveBtn.className = "btn btn-primary";
            saveBtn.textContent = "Enregistrer";
            saveBtn.addEventListener("click", () => {
              form.requestSubmit();
            });

            bar.appendChild(cancelBtn);
            bar.appendChild(saveBtn);
            document.body.appendChild(bar);
          }

          // Ré-attacher les listeners de validation + submit
          attachValidation();
          attachSubmitListener();

          // Charger les données après injection pour être sûr que les champs existent
          await loadData();

          // Initialiser autoRepeat sur les conteneurs dynamiques
          function autoRepeat(container) {
            container.addEventListener("input", () => {
              const lastRow = container.querySelector(".repeat-row:last-child");
              if (!lastRow) return;
              const inputs = [...lastRow.querySelectorAll("input")];
              const filled = inputs.filter((i) => i.value.trim() !== "");
              if (filled.length === inputs.length) {
                const clone = lastRow.cloneNode(true);
                clone.querySelectorAll("input").forEach((i) => (i.value = ""));
                container.appendChild(clone);
              }
            });
          }

          [
            "honorairesContainer",
            "fraisContainer",
            "deboursContainer",
            "tvaCollecteContainer",
            "tresorerieContainer",
          ].forEach((id) => {
            const el = document.getElementById(id);
            if (el) autoRepeat(el);
          });
        } catch (err) {
          showAlert(err.message, "danger");
        }
      }

      function attachValidation() {
        form.classList.add("needs-validation");
        form.addEventListener(
          "submit",
          (event) => {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add("was-validated");
          },
          false
        );
      }

      function attachSubmitListener() {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!form.checkValidity()) return;

          const formData = new FormData(form);
          const payload = {};
          for (const [key, value] of formData.entries()) {
            if (payload[key]) {
              if (Array.isArray(payload[key])) {
                payload[key].push(value);
              } else {
                payload[key] = [payload[key], value];
              }
            } else {
              payload[key] = value;
            }
          }
          payload.timestamp = new Date().toISOString();

          try {
            const res = await fetch(
              `/api/questionnaire/${encodeURIComponent(originalCabinetName)}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              }
            );
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Erreur");
            showAlert("Modifications enregistrées.", "success");
            // Stocker une notification pour la page liste puis rediriger
            sessionStorage.setItem(
              "notificationMessage",
              "Modifications enregistrées."
            );
            sessionStorage.setItem("notificationType", "success");
            setTimeout(() => {
              window.location.href = "/consult.html";
            }, 500);
          } catch (err) {
            showAlert(err.message, "danger");
          }
        });
      }

      async function loadData() {
        try {
          const res = await fetch(
            `/api/questionnaire/${encodeURIComponent(originalCabinetName)}`
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Erreur de chargement");
          fillForm(data);
        } catch (err) {
          showAlert(err.message, "danger");
        }
      }

      function fillForm(data) {
        Object.entries(data).forEach(([key, value]) => {
          const elements = document.getElementsByName(key);
          if (!elements || elements.length === 0) return;
          if (elements[0].type === "checkbox") {
            // Expect array
            const values = Array.isArray(value) ? value : [value];
            elements.forEach((el) => {
              el.checked = values.includes(el.value);
            });
          } else if (elements[0].type === "radio") {
            elements.forEach((el) => {
              el.checked = el.value === value;
            });
          } else {
            elements[0].value = value;
          }
        });
      }

      function showAlert(message, type) {
        let container =
          alertPlaceholder || document.getElementById("alertPlaceholder");
        // Si aucun conteneur, en créer un en tête de page pour éviter d'effacer le contenu
        if (!container) {
          container = document.createElement("div");
          container.id = "alertPlaceholder";
          document.body.prepend(container);
        }
        container.innerHTML = `
          <div class="alert alert-${type} alert-dismissible mb-0" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`;
      }

      // Démarre le flux : injecte d'abord le template, puis loadData() sera appelé depuis injectFormTemplate
      injectFormTemplate();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
