<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consultation Questionnaires</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link href="/css/theme-septeo.css" rel="stylesheet" />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <header class="d-flex align-items-center mb-4">
        <img src="/img/logo-septeo.svg" alt="SEPTEO" height="40" class="me-3" />
        <h1 class="h3 mb-0 fw-semibold">Consultation des questionnaires</h1>
      </header>
      <div id="alertPlaceholder" class="pt-2"></div>
      <div class="d-flex justify-content-between mb-3">
        <input
          type="search"
          id="searchInput"
          class="form-control w-50"
          placeholder="Rechercher par nom de cabinet..."
        />
        <a href="/index.html" class="btn btn-secondary"
          >Nouveau questionnaire</a
        >
      </div>

      <table class="table septeo-table" id="resultsTable">
        <thead>
          <tr>
            <th>Nom du cabinet</th>
            <th>Contact</th>
            <th>Date</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      async function fetchList(query = "") {
        const res = await fetch(
          `/api/questionnaires?search=${encodeURIComponent(query)}`
        );
        const data = await res.json();
        populateTable(data);
      }

      function populateTable(items) {
        const tbody = document.querySelector("#resultsTable tbody");
        tbody.innerHTML = "";
        items.forEach((item) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.cabinetName}</td>
            <td>${item.contactName || ""}</td>
            <td>${
              item.timestamp ? new Date(item.timestamp).toLocaleString() : ""
            }</td>
            <td><a href="/edit.html?cabinetName=${encodeURIComponent(
              item.cabinetName
            )}" class="btn btn-sm btn-primary">Ouvrir</a></td>
          `;
          tbody.appendChild(tr);
        });
      }

      document.getElementById("searchInput").addEventListener("input", (e) => {
        fetchList(e.target.value);
      });

      // Initial load
      fetchList();

      function showAlert(message, type = "success") {
        const container = document.getElementById("alertPlaceholder");
        if (!container) return;
        container.innerHTML = `
          <div class="alert alert-${type} alert-dismissible" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`;
      }

      // Afficher une notification Ã©ventuelle provenant d'une autre page
      const notifMsg = sessionStorage.getItem("notificationMessage");
      if (notifMsg) {
        const notifType =
          sessionStorage.getItem("notificationType") || "success";
        showAlert(notifMsg, notifType);
        sessionStorage.removeItem("notificationMessage");
        sessionStorage.removeItem("notificationType");
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
